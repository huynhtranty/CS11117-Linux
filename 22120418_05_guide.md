# SSH Configuration Assignment Guide

## Overview
This guide provides step-by-step instructions for completing the SSH configuration assignment, including disabling root SSH access, configuring SFTP-only access, and setting up SSH key-based authentication.

---

## Task 1: Disable SSH Access for the Root User

### Steps:

1. **Backup the SSH configuration file**
   ```bash
   sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
   ```

2. **Edit the SSH configuration file**
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```

3. **Find and modify the following line:**
   ```
   #PermitRootLogin yes
   ```
   
   Change it to:
   ```
   PermitRootLogin no
   ```

4. **Save and exit** (Ctrl+X, then Y, then Enter)

5. **Test the configuration for syntax errors**
   ```bash
   sudo sshd -t
   ```

6. **Restart the SSH service**
   
   For CentOS/RHEL 7+:
   ```bash
   sudo systemctl restart sshd
   sudo systemctl status sshd
   ```
   
   For older systems:
   ```bash
   sudo service sshd restart
   sudo service sshd status
   ```

### Verification:

Try to SSH as root (this should fail):
```bash
ssh root@localhost
```

Expected result: **Permission denied** or connection refused for root user.

### Screenshots to include:
- Configuration file showing `PermitRootLogin no`
- SSH service status after restart
- Failed login attempt as root

---

## Task 2: Allow SFTP Access but Deny SSH Shell Access

### Steps:

1. **Create the SFTP user**
   ```bash
   sudo useradd -m -s /sbin/nologin sftpuser
   sudo passwd sftpuser
   ```

2. **Create the chroot directory structure**
   ```bash
   sudo mkdir -p /home/sftpuser/uploads
   ```

3. **Set proper ownership and permissions**
   ```bash
   sudo chown root:root /home/sftpuser
   sudo chmod 755 /home/sftpuser
   sudo chown sftpuser:sftpuser /home/sftpuser/uploads
   ```

4. **Edit the SSH configuration file**
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```

5. **Add the following configuration at the end of the file:**
   ```
   # SFTP-only user configuration
   Match User sftpuser
       ForceCommand internal-sftp
       PasswordAuthentication yes
       ChrootDirectory /home/sftpuser
       PermitTunnel no
       AllowAgentForwarding no
       AllowTcpForwarding no
       X11Forwarding no
   ```

6. **Save and test the configuration**
   ```bash
   sudo sshd -t
   ```

7. **Restart SSH service**
   ```bash
   sudo systemctl restart sshd
   ```

### Verification:

**Test SFTP access (should work):**
```bash
sftp sftpuser@localhost
```

Once connected, try these commands:
```
sftp> pwd
sftp> ls
sftp> cd uploads
sftp> put testfile.txt
sftp> ls
sftp> exit
```

**Test SSH access (should fail):**
```bash
ssh sftpuser@localhost
```

Expected result: Connection should close immediately or show "This service allows sftp connections only"

### Screenshots to include:
- User creation commands
- Directory structure and permissions (`ls -la /home/sftpuser`)
- sshd_config Match block for sftpuser
- Successful SFTP connection
- Failed SSH shell attempt

---

## Task 3: Configure SSH Key-Based Authentication

### Steps:

1. **Create the user account**
   ```bash
   sudo useradd -m studentuser
   sudo passwd studentuser
   ```

2. **Switch to the user or generate keys as the user**
   
   From the client side (or as studentuser):
   ```bash
   ssh-keygen -t rsa -b 4096 -C "studentuser@hostname"
   ```
   
   Press Enter to accept default location (`~/.ssh/id_rsa`)
   
   Press Enter twice for no passphrase (or set one for extra security)

3. **Create .ssh directory for the user (if running as root/sudo)**
   ```bash
   sudo mkdir -p /home/studentuser/.ssh
   sudo chmod 700 /home/studentuser/.ssh
   ```

4. **Copy the public key to authorized_keys**
   
   If you generated the key as studentuser:
   ```bash
   cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```
   
   If copying from another machine:
   ```bash
   ssh-copy-id studentuser@server_ip
   ```
   
   Or manually:
   ```bash
   sudo nano /home/studentuser/.ssh/authorized_keys
   # Paste the public key here
   sudo chmod 600 /home/studentuser/.ssh/authorized_keys
   sudo chown -R studentuser:studentuser /home/studentuser/.ssh
   ```

5. **Test key-based authentication**
   ```bash
   ssh studentuser@localhost
   ```
   
   This should log in without asking for a password.

6. **Disable password authentication (enhance security)**
   
   Edit SSH config:
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```
   
   Find and modify these lines:
   ```
   PasswordAuthentication no
   PubkeyAuthentication yes
   ChallengeResponseAuthentication no
   ```
   
   **Important Note:** Make sure you have key-based access working BEFORE disabling password authentication!

7. **Restart SSH service**
   ```bash
   sudo sshd -t
   sudo systemctl restart sshd
   ```

### Verification:

**Test SSH key authentication:**
```bash
ssh studentuser@localhost
```

Expected result: Login successful without password prompt

**Verify password login is disabled:**

Try to SSH with password authentication explicitly:
```bash
ssh -o PubkeyAuthentication=no studentuser@localhost
```

Expected result: Permission denied (no password prompt)

### Screenshots to include:
- Key generation output
- Public key content (`cat ~/.ssh/id_rsa.pub`)
- authorized_keys file
- sshd_config showing password authentication disabled
- Successful SSH login without password
- Failed login attempt when trying to force password authentication

---

## Final Configuration Summary

Your `/etc/ssh/sshd_config` should include:

```
# Disable root login
PermitRootLogin no

# Enable public key authentication
PubkeyAuthentication yes

# Disable password authentication
PasswordAuthentication no
ChallengeResponseAuthentication no

# SFTP-only configuration for sftpuser
Match User sftpuser
    ForceCommand internal-sftp
    PasswordAuthentication yes
    ChrootDirectory /home/sftpuser
    PermitTunnel no
    AllowAgentForwarding no
    AllowTcpForwarding no
    X11Forwarding no
```

---

## Troubleshooting Tips

### Common Issues:

1. **SSH service won't restart**
   - Run `sudo sshd -t` to check for syntax errors
   - Check logs: `sudo tail -f /var/log/secure` or `sudo journalctl -u sshd -f`

2. **SFTP user can't log in**
   - Verify directory ownership: `ls -la /home/sftpuser`
   - Home directory must be owned by root
   - Check SELinux: `sudo setsebool -P ssh_chroot_rw_homedirs on` (if applicable)

3. **Key authentication not working**
   - Check permissions:
     - `.ssh` directory: 700
     - `authorized_keys` file: 600
   - Verify ownership: `sudo chown -R username:username /home/username/.ssh`
   - Check SSH logs for detailed error messages

4. **Locked out of server**
   - Always keep one terminal session open while testing
   - Test changes before disconnecting
   - Have console access available

---

## Security Best Practices

1. **Use strong key algorithms**: RSA 4096-bit or ED25519
2. **Set key passphrase**: Adds extra security layer
3. **Limit SSH access by user**: Use `AllowUsers` directive
4. **Change default SSH port**: Edit `Port` in sshd_config
5. **Use fail2ban**: Protects against brute force attacks
6. **Keep SSH updated**: Regularly update OpenSSH package
7. **Regular audit**: Review authorized_keys periodically

---

## Report Structure Recommendation

Your PDF report should include:

### 1. Introduction
- Brief overview of the assignment objectives
- System information (OS version, SSH version)

### 2. Task 1: Disable Root SSH Access
- Configuration changes made
- Screenshot of configuration file
- Screenshot of service restart
- Screenshot of failed root login
- Explanation of expected results

### 3. Task 2: SFTP-Only Access
- User creation and directory setup
- Configuration changes
- Screenshot of SFTP configuration in sshd_config
- Screenshot of successful SFTP connection
- Screenshot of failed SSH shell attempt
- Explanation of chroot jail concept

### 4. Task 3: SSH Key-Based Authentication
- Key generation process
- Configuration changes
- Screenshot of public key
- Screenshot of successful key-based login
- Screenshot showing password authentication disabled
- Security benefits explanation

### 5. Conclusion
- Summary of configurations implemented
- Security improvements achieved
- Lessons learned

### 6. Appendix
- Complete sshd_config file (relevant sections)
- References used

---

## Useful Commands Reference

```bash
# Check SSH service status
sudo systemctl status sshd

# View SSH logs
sudo tail -f /var/log/secure          # CentOS/RHEL
sudo tail -f /var/log/auth.log        # Ubuntu/Debian

# Test SSH configuration
sudo sshd -t

# List active SSH connections
who
w

# View failed login attempts
sudo lastb

# Check file permissions
ls -la /home/username/.ssh/

# Generate SSH key pair
ssh-keygen -t rsa -b 4096

# Copy public key to server
ssh-copy-id user@server

# SSH with specific key
ssh -i ~/.ssh/id_rsa user@server

# SFTP connection
sftp user@server

# Check SELinux status (if applicable)
getenforce
sudo setsebool -P ssh_chroot_rw_homedirs on
```

---

## Additional Resources

- Official OpenSSH Documentation: https://www.openssh.com/manual.html
- SSH.com SSH Academy: https://www.ssh.com/academy/ssh
- DigitalOcean SSH Tutorials: https://www.digitalocean.com/community/tags/ssh

---

*Note: This guide is intended for educational purposes. Always test configurations in a safe environment before applying to production systems.*